<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%221em%22 font-size=%2280%22>üèÅ</text></svg>">
    <title>F1 Session Countdown</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e3c72;
            color: white;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        h1 {
            margin-bottom: 20px;
        }
        .loading {
            font-size: 1.5em;
            font-weight: bold;
        }
        .event-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }
        .event {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .countdown {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2.5em;
            font-weight: bold;
        }
        .countdown div {
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            min-width: 60px;
            text-align: center;
        }
        .label {
            font-size: 0.5em;
            display: block;
            margin-top: 5px;
        }
        a {
            color: hotpink;
        }
    </style>
</head>
<body>
    <h1>üèÅ F1 Session Countdown üèÅ</h1>
    <pre>No ads, few features. Created by <a href="https://bsky.app/profile/wsjudd.bsky.social">@wsjudd</a>.</pre>
    <div id="loading" class="loading">Loading events...</div>
    <div class="event-container" id="events" style="display:none;"></div>

    <script type="module">
        import ICAL from 'https://unpkg.com/ical.js/dist/ical.min.js';
        
        const ICAL_URL = 'https://raw.githubusercontent.com/silentdragoon/f1count/refs/heads/main/Formula_1.ics';

        async function fetchEvents() {
            try {
                const response = await fetch(ICAL_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const icalData = await response.text();
                requestAnimationFrame(() => processICalData(icalData));
            } catch (error) {
                document.getElementById('loading').innerText = 'Error loading events';
            }
        }

        function processICalData(icalData) {
    try {
        const parsed = ICAL.parse(icalData);
        const comp = new ICAL.Component(parsed);
        const events = comp.getAllSubcomponents('vevent').map(vevent => new ICAL.Event(vevent));
        
        const now = new Date();
        const upcomingEvents = events.filter(event => event.startDate.toJSDate() > now)
                                    .sort((a, b) => a.startDate.toJSDate() - b.startDate.toJSDate())
                                    .slice(0, 10); // Display 10 events for testing

        const raceWeekends = {}; // To group and track race weekends
        const darkPastelColors = ['#6A5ACD', '#708090', '#8B0000', '#4682B4', '#556B2F']; // Dark pastel colours
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('events').style.display = 'flex';
        document.getElementById('events').innerHTML = '';
        
        upcomingEvents.forEach((event, index) => {
            // Clean title: remove emoji and unnecessary info, then format
            const fullTitle = event.summary.replace(/FORMULA 1|2025/g, '').trim();
            const cleanedTitle = toTitleCase(fullTitle.replace(/^[^\w]+/, '').trim()); // Remove leading emoji or symbols
            const raceName = cleanedTitle.split('-')[0].trim(); // Extract race weekend name
            
            if (!raceWeekends[raceName]) {
                const colorIndex = Object.keys(raceWeekends).length % darkPastelColors.length;
                raceWeekends[raceName] = darkPastelColors[colorIndex]; // Assign a dark pastel colour in rotation
            }
            
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.style.backgroundColor = raceWeekends[raceName]; // Apply the race weekend's colour
            
            const eventDate = event.startDate.toJSDate();
            const localTime = eventDate.toLocaleString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
            
            eventDiv.innerHTML = `<h3>${cleanedTitle}</h3>
                                 <p>${localTime}</p>
                                 <div id='event${index + 1}-timer' class='countdown'></div>`;
            document.getElementById('events').appendChild(eventDiv);
            startCountdown(event, `event${index + 1}-timer`);
        });
    } catch (error) {
        document.getElementById('loading').innerText = 'Error processing events';
    }
}

// Helper function to convert text to title case
function toTitleCase(text) {
    return text.toLowerCase()
               .replace(/\b\w/g, char => char.toUpperCase());
}




        function startCountdown(event, elementId) {
            const countDownDate = event.startDate.toJSDate().getTime();
            
            function updateTimer() {
                const now = new Date().getTime();
                const distance = countDownDate - now;
                const element = document.getElementById(elementId);
                
                if (distance < 0) {
                    element.innerHTML = 'Event Started';
                    return;
                }
                
                const days = String(Math.floor(distance / (1000 * 60 * 60 * 24))).padStart(2, '0');
                const hours = String(Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0');
                const minutes = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                const seconds = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, '0');
                
                element.innerHTML = `
                    <div>${days}<span class='label'>DAYS</span></div>
                    <div>${hours}<span class='label'>HOURS</span></div>
                    <div>${minutes}<span class='label'>MINUTES</span></div>
                    <div>${seconds}<span class='label'>SECONDS</span></div>`;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        fetchEvents();
    </script>
</body>
</html>
