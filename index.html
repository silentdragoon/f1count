<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Countdown meow</title>
    <script src="https://unpkg.com/ical.js/dist/ical.min.js"></script>
</head>
<body>
    <h1>Upcoming Events</h1>
    <input type="file" id="fileInput" accept=".ics">
    <pre id="log"></pre>
    <div id="event1">
        <h2 id="event1-name"></h2>
        <p id="event1-timer"></p>
    </div>
    <div id="event2">
        <h2 id="event2-name"></h2>
        <p id="event2-timer"></p>
    </div>
    <div id="event3">
        <h2 id="event3-name"></h2>
        <p id="event3-timer"></p>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                log('File loaded successfully');
                processICalData(e.target.result);
            };
            reader.readAsText(file);
        });

        function log(message) {
            document.getElementById('log').textContent += message + '\n';
        }

        function processICalData(icalData) {
            try {
                const jcalData = ICAL.parse(icalData);
                const comp = new ICAL.Component(jcalData);
                const events = comp.getAllSubcomponents('vevent').map(vevent => new ICAL.Event(vevent));
                
                const now = new Date();
                const upcomingEvents = events.filter(event => event.startDate.toJSDate() > now)
                                            .sort((a, b) => a.startDate.toJSDate() - b.startDate.toJSDate())
                                            .slice(0, 3);
                
                if (upcomingEvents.length === 0) {
                    log('No upcoming events found');
                } else {
                    log(`Found ${upcomingEvents.length} upcoming events`);
                }

                upcomingEvents.forEach((event, index) => {
                    document.getElementById(`event${index + 1}-name`).innerText = event.summary;
                    startCountdown(event, `event${index + 1}-timer`);
                    log(`Event ${index + 1}: ${event.summary} at ${event.startDate.toJSDate()}`);
                });
            } catch (error) {
                log('Error parsing iCal file: ' + error.message);
            }
        }

        function startCountdown(event, elementId) {
            const countDownDate = event.startDate.toJSDate().getTime();
            
            const x = setInterval(function() {
                const now = new Date().getTime();
                const distance = countDownDate - now;
                if (distance < 0) {
                    clearInterval(x);
                    document.getElementById(elementId).innerHTML = 'Event Started';
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById(elementId).innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }
    </script>
</body>
</html>
